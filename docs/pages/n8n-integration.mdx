# n8n Integration

This document describes how to set up n8n workflows for SumUp integration with the Hans Restaurant App.

## Overview

n8n is used to automate the synchronization of payment data from SumUp to the Hans Restaurant App. The integration includes:

- **Credential Management**: Secure retrieval of encrypted SumUp API keys
- **Data Synchronization**: Automated fetching of transaction data
- **Webhook Processing**: Real-time transaction updates
- **Error Handling**: Robust error handling and retry mechanisms

## Setup

### 1. Environment Variables

#### Hans Restaurant App (.env.local)

Configure the following environment variables in your Hans Restaurant App:

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key

# Encryption Configuration
ENCRYPTION_KEY=your-32-character-encryption-key-here
# Example: ENCRYPTION_KEY=my-super-secret-32-char-key-12345

# n8n Integration
N8N_SHARED_SECRET=your-shared-secret-for-n8n
# Example: N8N_SHARED_SECRET=n8n-hans-integration-secret-2024

# SumUp Webhook (optional)
SUMUP_WEBHOOK_SECRET=your-sumup-webhook-secret
# Example: SUMUP_WEBHOOK_SECRET=sumup-webhook-secret-key-123
```

#### n8n Instance (.env)

Configure the following environment variables in your n8n instance:

```bash
# Hans Restaurant App API
HANS_API_URL=https://your-domain.com/api
N8N_SHARED_SECRET=your-shared-secret-for-n8n
# Must match the N8N_SHARED_SECRET in Hans Restaurant App

# n8n Configuration
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your-n8n-password

# Database (if using external database)
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=your-postgres-host
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=your-postgres-password
```

#### Supabase Environment Variables

In your Supabase project settings, ensure these are configured:

```bash
# Database URL
DATABASE_URL=postgresql://postgres:[password]@[host]:5432/postgres

# Service Role Key (for admin operations)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Anon Key (for client operations)
SUPABASE_ANON_KEY=your-anon-key
```

### 2. n8n Workflow: SumUp Data Sync

Create a new workflow with the following nodes:

#### Node 1: HTTP Request - Get Credentials
- **Method**: GET
- **URL**: `{{ $env.HANS_API_URL }}/merchant-codes/credentials`
- **Headers**:
  ```json
  {
    "Authorization": "Bearer {{ $env.N8N_SHARED_SECRET }}",
    "Content-Type": "application/json"
  }
  ```
- **Query Parameters**:
  - `organization_id`: The organization ID to sync
  - `merchant_code`: The specific merchant code to sync

#### Node 2: HTTP Request - Fetch SumUp Transactions
- **Method**: GET
- **URL**: `https://api.sumup.com/v0.1/me/transactions`
- **Headers**:
  ```json
  {
    "Authorization": "Bearer {{ $json.access_token }}",
    "Content-Type": "application/json"
  }
  ```
- **Query Parameters**:
  - `merchant_code`: `{{ $json.merchant_code }}`
  - `from`: Start date (e.g., `2024-01-01`)
  - `to`: End date (e.g., `2024-01-31`)

#### Node 3: HTTP Request - Send to Hans App
- **Method**: POST
- **URL**: `{{ $env.HANS_API_URL }}/webhooks/sumup`
- **Headers**:
  ```json
  {
    "Content-Type": "application/json",
    "x-sumup-signature": "{{ $json.signature }}"
  }
  ```
- **Body**: Transaction data from SumUp

### 3. n8n Workflow: Webhook Processing

Create a webhook workflow to handle real-time SumUp webhooks:

#### Node 1: Webhook Trigger
- **HTTP Method**: POST
- **Path**: `/sumup-webhook`
- **Response Mode**: Response Code

#### Node 2: HTTP Request - Forward to Hans App
- **Method**: POST
- **URL**: `{{ $env.HANS_API_URL }}/webhooks/sumup`
- **Headers**:
  ```json
  {
    "Content-Type": "application/json",
    "x-sumup-signature": "{{ $headers['x-sumup-signature'] }}"
  }
  ```
- **Body**: `{{ $json }}`

## Configuration Guide

### Step-by-Step Setup

#### 1. Hans Restaurant App Configuration

1. **Create Environment File**:
   ```bash
   # In your Hans Restaurant App root directory
   cp .env.example .env.local
   ```

2. **Generate Encryption Key**:
   ```bash
   # Generate a 32-character encryption key
   openssl rand -hex 16
   # Example output: a1b2c3d4e5f6789012345678901234567890abcd
   ```

3. **Generate n8n Shared Secret**:
   ```bash
   # Generate a secure shared secret
   openssl rand -base64 32
   # Example output: n8n-hans-integration-secret-2024-xyz789
   ```

4. **Update .env.local**:
   ```bash
   # Copy the generated keys to your .env.local file
   ENCRYPTION_KEY=a1b2c3d4e5f6789012345678901234567890abcd
   N8N_SHARED_SECRET=n8n-hans-integration-secret-2024-xyz789
   ```

#### 2. n8n Configuration

1. **Install n8n**:
   ```bash
   # Using npm
   npm install -g n8n
   
   # Or using Docker
   docker run -it --rm --name n8n -p 5678:5678 -v ~/.n8n:/home/node/.n8n n8nio/n8n
   ```

2. **Create n8n Environment File**:
   ```bash
   # Create .env file in your n8n directory
   cat > .env << EOF
   HANS_API_URL=https://your-domain.com/api
   N8N_SHARED_SECRET=n8n-hans-integration-secret-2024-xyz789
   N8N_BASIC_AUTH_ACTIVE=true
   N8N_BASIC_AUTH_USER=admin
   N8N_BASIC_AUTH_PASSWORD=your-secure-password
   EOF
   ```

3. **Start n8n**:
   ```bash
   n8n start
   ```

#### 3. Supabase Configuration

1. **Get Supabase Keys**:
   - Go to your Supabase project dashboard
   - Navigate to Settings > API
   - Copy the following keys:
     - `Project URL` → `NEXT_PUBLIC_SUPABASE_URL`
     - `anon public` → `NEXT_PUBLIC_SUPABASE_ANON_KEY`
     - `service_role secret` → `SUPABASE_SERVICE_ROLE_KEY`

2. **Update Hans Restaurant App .env.local**:
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

#### 4. SumUp Configuration

1. **Get SumUp API Credentials**:
   - Log in to your SumUp merchant dashboard
   - Navigate to Settings > API
   - Generate API Key and Secret

2. **Configure Webhook** (optional):
   - Set webhook URL: `https://your-domain.com/api/webhooks/sumup`
   - Set webhook secret: `your-sumup-webhook-secret`

3. **Update Hans Restaurant App .env.local**:
   ```bash
   SUMUP_WEBHOOK_SECRET=your-sumup-webhook-secret
   ```

## Security

### API Key Encryption

The Hans Restaurant App uses AES-256-GCM encryption to store SumUp API credentials:

- **Encryption Algorithm**: AES-256-GCM
- **Key Derivation**: Uses a shared secret key
- **Salt Generation**: Random salt for each credential set
- **Secure Storage**: Encrypted credentials stored in database

### Key Management

#### Encryption Key Requirements

- **Length**: Exactly 32 characters
- **Format**: Hexadecimal string
- **Security**: Must be kept secret and secure
- **Storage**: Store in environment variables only

#### Salt Generation

- **Automatic**: Generated automatically for each merchant code
- **Uniqueness**: Each credential set gets a unique salt
- **Storage**: Stored alongside encrypted credentials
- **Purpose**: Prevents rainbow table attacks

#### Shared Secret Requirements

- **Length**: Minimum 32 characters
- **Format**: Base64 or hexadecimal string
- **Security**: Must be kept secret
- **Synchronization**: Must match between Hans App and n8n

### Authentication

n8n authenticates with the Hans Restaurant App using:

- **Shared Secret**: Pre-configured secret key
- **Bearer Token**: Sent in Authorization header
- **Organization Isolation**: Only access to authorized organization data

## Error Handling

### Retry Logic

Implement exponential backoff for failed requests:

```javascript
// n8n Function Node
const maxRetries = 3;
const baseDelay = 1000; // 1 second

for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    // Make API request
    const response = await $http.request({
      method: 'POST',
      url: 'https://api.sumup.com/v0.1/me/transactions',
      // ... other options
    });
    
    if (response.status === 200) {
      return response.data;
    }
  } catch (error) {
    if (attempt === maxRetries) {
      throw error;
    }
    
    const delay = baseDelay * Math.pow(2, attempt - 1);
    await new Promise(resolve => setTimeout(resolve, delay));
  }
}
```

### Error Notifications

Configure error notifications for failed syncs:

- **Email Alerts**: Send notifications to administrators
- **Slack Integration**: Post errors to Slack channel
- **Logging**: Comprehensive error logging

## Monitoring

### Health Checks

Set up health checks to monitor the integration:

- **Credential Validation**: Verify API keys are valid
- **Sync Status**: Check last successful sync
- **Error Rates**: Monitor failure rates

### Metrics

Track key metrics:

- **Sync Frequency**: How often data is synchronized
- **Transaction Volume**: Number of transactions processed
- **Error Count**: Number of failed operations
- **Response Times**: API response times

## Troubleshooting

### Common Issues

1. **Authentication Failures**
   - Verify shared secret is correct
   - Check organization ID and merchant code
   - Ensure API keys are valid

2. **Data Sync Issues**
   - Check SumUp API rate limits
   - Verify date ranges are correct
   - Check network connectivity

3. **Webhook Failures**
   - Verify webhook URL is accessible
   - Check signature validation
   - Ensure proper error handling

### Debug Mode

Enable debug logging in n8n:

```javascript
// Add to Function Node
console.log('Debug info:', {
  credentials: $json,
  transactionData: $input.all(),
  timestamp: new Date().toISOString()
});
```

## Best Practices

1. **Rate Limiting**: Respect SumUp API rate limits
2. **Data Validation**: Validate all incoming data
3. **Error Handling**: Implement comprehensive error handling
4. **Monitoring**: Set up proper monitoring and alerting
5. **Security**: Keep credentials secure and rotate regularly
6. **Testing**: Test workflows thoroughly before production

---

*Last updated: 2025-01-22*
