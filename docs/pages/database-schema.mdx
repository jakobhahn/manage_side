# Database Schema

This document describes the complete database schema for the Hans Restaurant Management Platform, including all tables, relationships, and constraints.

## Schema Overview

The database is designed as a multi-tenant SaaS system with the following key principles:
- **Multi-tenancy**: Each organization has isolated data
- **Modularity**: Module-specific tables for different features
- **Security**: Row-level security (RLS) on all tables
- **Scalability**: Optimized for high-performance queries
- **Auditability**: Complete audit trail for all changes

## Core Tables

### Organizations
Central table for multi-tenant architecture.

```sql
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  settings JSONB DEFAULT '{}',
  subscription_tier VARCHAR(50) DEFAULT 'free',
  billing_email VARCHAR(255),
  timezone VARCHAR(50) DEFAULT 'Europe/Berlin',
  currency VARCHAR(3) DEFAULT 'EUR',
  is_active BOOLEAN DEFAULT true,
  trial_ends_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_organizations_slug ON organizations(slug);
CREATE INDEX idx_organizations_active ON organizations(is_active);

-- RLS
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their organization" ON organizations
  FOR SELECT USING (id = auth.jwt() ->> 'organization_id'::text);
```

### Users
Staff members and system users.

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL CHECK (role IN ('owner', 'manager', 'staff', 'admin')),
  permissions JSONB DEFAULT '[]',
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_users_organization_id ON users(organization_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view organization members" ON users
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

### Module Subscriptions
Track which modules each organization has access to.

```sql
CREATE TABLE module_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  module_name VARCHAR(100) NOT NULL CHECK (module_name IN (
    'revenue_analytics', 'shift_planning', 'inventory_management',
    'time_clock', 'sales_management', 'kpi_dashboard',
    'reporting', 'menu_management'
  )),
  is_active BOOLEAN DEFAULT true,
  subscription_tier VARCHAR(50) DEFAULT 'basic' CHECK (subscription_tier IN ('basic', 'pro', 'enterprise')),
  features JSONB DEFAULT '{}',
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(organization_id, module_name)
);

-- Indexes
CREATE INDEX idx_module_subscriptions_org_id ON module_subscriptions(organization_id);
CREATE INDEX idx_module_subscriptions_active ON module_subscriptions(is_active);

-- RLS
ALTER TABLE module_subscriptions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view organization subscriptions" ON module_subscriptions
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

## Payment Integration Tables

### Payment Transactions
Core table for all payment data from SumUp and other sources.

```sql
CREATE TABLE payment_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  sumup_transaction_id VARCHAR(255) UNIQUE,
  amount DECIMAL(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'EUR',
  payment_method VARCHAR(50) NOT NULL,
  status VARCHAR(50) NOT NULL,
  transaction_date TIMESTAMP WITH TIME ZONE NOT NULL,
  customer_email VARCHAR(255),
  customer_name VARCHAR(255),
  location_id VARCHAR(100),
  device_id VARCHAR(100),
  raw_data JSONB,
  processed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_payment_transactions_org_id ON payment_transactions(organization_id);
CREATE INDEX idx_payment_transactions_date ON payment_transactions(transaction_date);
CREATE INDEX idx_payment_transactions_sumup_id ON payment_transactions(sumup_transaction_id);
CREATE INDEX idx_payment_transactions_status ON payment_transactions(status);

-- RLS
ALTER TABLE payment_transactions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view organization transactions" ON payment_transactions
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

### Revenue Analytics
Aggregated revenue data for analytics.

```sql
CREATE TABLE revenue_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  total_revenue DECIMAL(10,2) DEFAULT 0,
  transaction_count INTEGER DEFAULT 0,
  average_transaction DECIMAL(10,2) DEFAULT 0,
  payment_methods JSONB DEFAULT '{}',
  hourly_breakdown JSONB DEFAULT '{}',
  peak_hours JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(organization_id, date)
);

-- Indexes
CREATE INDEX idx_revenue_analytics_org_date ON revenue_analytics(organization_id, date);
CREATE INDEX idx_revenue_analytics_date ON revenue_analytics(date);

-- RLS
ALTER TABLE revenue_analytics ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view organization revenue" ON revenue_analytics
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

## Module-Specific Tables

### Shift Planning Module

```sql
-- Shifts
CREATE TABLE shifts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,
  position VARCHAR(100),
  status VARCHAR(50) DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'confirmed', 'completed', 'cancelled')),
  hourly_rate DECIMAL(8,2),
  notes TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Shift Requests
CREATE TABLE shift_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  shift_id UUID REFERENCES shifts(id) ON DELETE CASCADE,
  request_type VARCHAR(50) NOT NULL CHECK (request_type IN ('swap', 'cover', 'time_off')),
  status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  reason TEXT,
  requested_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  responded_at TIMESTAMP WITH TIME ZONE,
  responded_by UUID REFERENCES users(id)
);

-- Indexes
CREATE INDEX idx_shifts_org_id ON shifts(organization_id);
CREATE INDEX idx_shifts_user_id ON shifts(user_id);
CREATE INDEX idx_shifts_date ON shifts(start_time);
CREATE INDEX idx_shift_requests_org_id ON shift_requests(organization_id);

-- RLS
ALTER TABLE shifts ENABLE ROW LEVEL SECURITY;
ALTER TABLE shift_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view organization shifts" ON shifts
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view organization shift requests" ON shift_requests
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

### Inventory Management Module

```sql
-- Inventory Items
CREATE TABLE inventory_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  category VARCHAR(100),
  description TEXT,
  current_stock DECIMAL(10,2) DEFAULT 0,
  unit VARCHAR(50) NOT NULL,
  reorder_point DECIMAL(10,2) DEFAULT 0,
  reorder_quantity DECIMAL(10,2) DEFAULT 0,
  cost_per_unit DECIMAL(10,2) DEFAULT 0,
  supplier VARCHAR(255),
  supplier_contact JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Inventory Movements
CREATE TABLE inventory_movements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  item_id UUID REFERENCES inventory_items(id) ON DELETE CASCADE,
  movement_type VARCHAR(50) NOT NULL CHECK (movement_type IN ('in', 'out', 'adjustment', 'waste')),
  quantity DECIMAL(10,2) NOT NULL,
  unit_cost DECIMAL(10,2),
  total_cost DECIMAL(10,2),
  reason VARCHAR(255),
  reference_id UUID, -- Links to orders, waste reports, etc.
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_inventory_items_org_id ON inventory_items(organization_id);
CREATE INDEX idx_inventory_items_category ON inventory_items(category);
CREATE INDEX idx_inventory_movements_item_id ON inventory_movements(item_id);
CREATE INDEX idx_inventory_movements_date ON inventory_movements(created_at);

-- RLS
ALTER TABLE inventory_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE inventory_movements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view organization inventory" ON inventory_items
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view organization movements" ON inventory_movements
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

### Time Clock Module

```sql
-- Time Clock Entries
CREATE TABLE time_clock_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  clock_in TIMESTAMP WITH TIME ZONE NOT NULL,
  clock_out TIMESTAMP WITH TIME ZONE,
  break_start TIMESTAMP WITH TIME ZONE,
  break_end TIMESTAMP WITH TIME ZONE,
  location_lat DECIMAL(10,8),
  location_lng DECIMAL(11,8),
  location_name VARCHAR(255),
  device_info JSONB,
  notes TEXT,
  is_approved BOOLEAN DEFAULT false,
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Time Clock Rules
CREATE TABLE time_clock_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  rules JSONB NOT NULL, -- Flexible rules configuration
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_time_clock_entries_user_id ON time_clock_entries(user_id);
CREATE INDEX idx_time_clock_entries_date ON time_clock_entries(clock_in);
CREATE INDEX idx_time_clock_rules_org_id ON time_clock_rules(organization_id);

-- RLS
ALTER TABLE time_clock_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE time_clock_rules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view organization time entries" ON time_clock_entries
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view organization time rules" ON time_clock_rules
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

### Sales Management Module

```sql
-- Customers
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  email VARCHAR(255),
  name VARCHAR(255) NOT NULL,
  phone VARCHAR(50),
  address JSONB,
  loyalty_points INTEGER DEFAULT 0,
  total_spent DECIMAL(10,2) DEFAULT 0,
  last_visit TIMESTAMP WITH TIME ZONE,
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Orders
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  customer_id UUID REFERENCES customers(id),
  order_number VARCHAR(100) UNIQUE NOT NULL,
  status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'preparing', 'ready', 'completed', 'cancelled')),
  total_amount DECIMAL(10,2) NOT NULL,
  payment_method VARCHAR(50),
  payment_status VARCHAR(50) DEFAULT 'pending',
  order_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  notes TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Order Items
CREATE TABLE order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  item_name VARCHAR(255) NOT NULL,
  quantity INTEGER NOT NULL,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(10,2) NOT NULL,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_customers_org_id ON customers(organization_id);
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_orders_org_id ON orders(organization_id);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_date ON orders(order_date);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);

-- RLS
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view organization customers" ON customers
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view organization orders" ON orders
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view order items" ON order_items
  FOR SELECT USING (order_id IN (
    SELECT id FROM orders WHERE organization_id = auth.jwt() ->> 'organization_id'::text
  ));
```

### Menu Management Module

```sql
-- Menu Categories
CREATE TABLE menu_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Menu Items
CREATE TABLE menu_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  category_id UUID REFERENCES menu_categories(id),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  price DECIMAL(10,2) NOT NULL,
  cost DECIMAL(10,2),
  preparation_time INTEGER, -- in minutes
  is_available BOOLEAN DEFAULT true,
  allergens JSONB DEFAULT '[]',
  nutritional_info JSONB DEFAULT '{}',
  images JSONB DEFAULT '[]',
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Menu Item Ingredients
CREATE TABLE menu_item_ingredients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  menu_item_id UUID REFERENCES menu_items(id) ON DELETE CASCADE,
  inventory_item_id UUID REFERENCES inventory_items(id),
  quantity DECIMAL(10,2) NOT NULL,
  unit VARCHAR(50) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_menu_categories_org_id ON menu_categories(organization_id);
CREATE INDEX idx_menu_items_org_id ON menu_items(organization_id);
CREATE INDEX idx_menu_items_category_id ON menu_items(category_id);
CREATE INDEX idx_menu_item_ingredients_menu_id ON menu_item_ingredients(menu_item_id);

-- RLS
ALTER TABLE menu_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE menu_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE menu_item_ingredients ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view organization menu categories" ON menu_categories
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view organization menu items" ON menu_items
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
CREATE POLICY "Users can view menu ingredients" ON menu_item_ingredients
  FOR SELECT USING (menu_item_id IN (
    SELECT id FROM menu_items WHERE organization_id = auth.jwt() ->> 'organization_id'::text
  ));
```

## Audit and Logging Tables

### Audit Log
Track all changes to important data.

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  table_name VARCHAR(100) NOT NULL,
  record_id UUID NOT NULL,
  action VARCHAR(50) NOT NULL CHECK (action IN ('INSERT', 'UPDATE', 'DELETE')),
  old_values JSONB,
  new_values JSONB,
  changed_by UUID REFERENCES users(id),
  changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_audit_logs_org_id ON audit_logs(organization_id);
CREATE INDEX idx_audit_logs_table_record ON audit_logs(table_name, record_id);
CREATE INDEX idx_audit_logs_date ON audit_logs(changed_at);

-- RLS
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view organization audit logs" ON audit_logs
  FOR SELECT USING (organization_id = auth.jwt() ->> 'organization_id'::text);
```

## Database Functions and Triggers

### Update Timestamp Function
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

### Audit Trigger Function
```sql
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_logs (
        organization_id,
        table_name,
        record_id,
        action,
        old_values,
        new_values,
        changed_by
    ) VALUES (
        COALESCE(NEW.organization_id, OLD.organization_id),
        TG_TABLE_NAME,
        COALESCE(NEW.id, OLD.id),
        TG_OP,
        CASE WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD) ELSE NULL END,
        CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN to_jsonb(NEW) ELSE NULL END,
        auth.jwt() ->> 'user_id'::text
    );
    RETURN COALESCE(NEW, OLD);
END;
$$ language 'plpgsql';
```

### Apply Triggers
```sql
-- Update timestamps
CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Audit triggers for critical tables
CREATE TRIGGER audit_organizations AFTER INSERT OR UPDATE OR DELETE ON organizations
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER audit_users AFTER INSERT OR UPDATE OR DELETE ON users
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER audit_payment_transactions AFTER INSERT OR UPDATE OR DELETE ON payment_transactions
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

## Performance Optimization

### Materialized Views
```sql
-- Daily revenue summary
CREATE MATERIALIZED VIEW daily_revenue_summary AS
SELECT 
    organization_id,
    DATE(transaction_date) as date,
    SUM(amount) as total_revenue,
    COUNT(*) as transaction_count,
    AVG(amount) as average_transaction
FROM payment_transactions
WHERE status = 'completed'
GROUP BY organization_id, DATE(transaction_date);

-- Refresh function
CREATE OR REPLACE FUNCTION refresh_daily_revenue_summary()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY daily_revenue_summary;
END;
$$ LANGUAGE plpgsql;
```

### Indexes for Performance
```sql
-- Composite indexes for common queries
CREATE INDEX idx_payment_transactions_org_date_status ON payment_transactions(organization_id, transaction_date, status);
CREATE INDEX idx_shifts_org_user_date ON shifts(organization_id, user_id, start_time);
CREATE INDEX idx_time_clock_entries_org_user_date ON time_clock_entries(organization_id, user_id, clock_in);
```

## Data Migration Scripts

### Initial Data Setup
```sql
-- Create default organization
INSERT INTO organizations (name, slug, subscription_tier) 
VALUES ('Demo Restaurant', 'demo-restaurant', 'pro');

-- Create admin user
INSERT INTO users (organization_id, email, name, role)
SELECT id, 'admin@demo-restaurant.com', 'Admin User', 'owner'
FROM organizations WHERE slug = 'demo-restaurant';

-- Enable all modules for demo
INSERT INTO module_subscriptions (organization_id, module_name, subscription_tier)
SELECT id, module_name, 'pro'
FROM organizations, unnest(ARRAY[
    'revenue_analytics', 'shift_planning', 'inventory_management',
    'time_clock', 'sales_management', 'kpi_dashboard',
    'reporting', 'menu_management'
]) AS module_name
WHERE slug = 'demo-restaurant';
```

This comprehensive database schema provides a solid foundation for the modular restaurant management platform with proper security, performance, and scalability considerations.
