# Architecture

This document describes the overall architecture of the Hans Restaurant Management Platform, a modular SaaS solution for restaurant management with integrated payment processing.

## System Overview

The Hans Restaurant Management Platform is built as a comprehensive, modular SaaS system with the following key components:

### Current Implementation Status

**âœ… Implemented Features:**
- Multi-tenant architecture with Row-Level Security (RLS)
- Role-based access control (Owner, Manager, Staff)
- Organization registration and user management
- Revenue analytics with real-time data processing
- Shift planning with manager editing capabilities
- Comprehensive API with authentication
- Responsive PWA with mobile-first design

**ðŸš§ In Development:**
- SumUp Integration with encrypted API key management
- Dashboard Enhancement with real data and charts
- Advanced shift management features

**ðŸ“‹ Planned Features:**
- Inventory management module
- Time clock with GPS verification
- Menu management
- Advanced reporting
- Subscription billing system

```mermaid
graph TB
    subgraph "Payment Integration"
        SumUp[SumUp Payment System]
        Webhook[Payment Webhooks]
    end
    
    subgraph "Frontend"
        Web[Next.js Web App - PWA]
        Mobile[Mobile-First Design]
    end
    
    subgraph "Core Platform"
        Auth[Supabase Auth & RLS]
        Modules[Module Registry]
        Billing[Subscription Management]
    end
    
    subgraph "Backend Services"
        API[Next.js API Routes]
        DB[(Supabase Postgres)]
        Storage[Supabase Storage]
        Edge[Supabase Edge Functions]
    end
    
    subgraph "Automation & Integration"
        n8n[n8n Workflows]
        Vercel[Vercel Hosting]
        Cursor[Cursor AI Development]
    end
    
    subgraph "Available Modules"
        Revenue[Revenue Analytics]
        Schedule[Shift Planning]
        Inventory[Inventory Management]
        TimeClock[Time Clock]
        Sales[Sales Management]
        KPIs[KPI Dashboard]
        Reports[Reporting]
        Menu[Menu Management]
    end
    
    SumUp --> Webhook
    Webhook --> n8n
    n8n --> DB
    Web --> API
    Mobile --> API
    API --> Auth
    API --> DB
    API --> Storage
    API --> Edge
    Auth --> Modules
    Billing --> Modules
    Modules --> Revenue
    Modules --> Schedule
    Modules --> Inventory
    Modules --> TimeClock
    Modules --> Sales
    Modules --> KPIs
    Modules --> Reports
    Modules --> Menu
```

## Technology Stack

### Frontend
- **Next.js 15** - React framework with App Router and Server Components
- **React 19** - Latest React with concurrent features
- **TypeScript** - Strict type checking and development
- **Tailwind CSS** - Utility-first CSS framework
- **shadcn/ui** - Modern component library
- **PWA** - Progressive Web App capabilities
- **Responsive Design** - Mobile-first approach

### Backend & Database
- **Next.js API Routes** - Serverless API endpoints with authentication
- **Supabase** - Complete Backend-as-a-Service
  - **PostgreSQL** - Multi-tenant database with RLS
  - **Authentication** - JWT-based auth with role management
  - **Row-Level Security** - Tenant data isolation
  - **Real-time** - Live data synchronization
  - **Storage** - File and media management
  - **Edge Functions** - Serverless compute
- **n8n** - Self-hosted workflow automation for SumUp integration

### Development & Infrastructure
- **Turborepo** - Monorepo build system with caching
- **pnpm** - Fast, disk space efficient package manager
- **Vercel** - Hosting, deployment, and edge functions
- **Docker** - Local development with Supabase
- **GitHub Actions** - CI/CD pipeline (planned)
- **Cursor AI** - AI-powered development environment

### Security & Monitoring
- **Row-Level Security (RLS)** - Database-level access control
- **JWT Authentication** - Secure token-based auth
- **Role-Based Access Control** - Owner, Manager, Staff permissions
- **Input Validation** - Zod schema validation
- **Error Monitoring** - Sentry integration (planned)
- **Analytics** - PostHog integration (planned)

## Data Architecture

### Multi-Tenant Database Design

The platform uses a multi-tenant architecture with Row-Level Security (RLS) to ensure complete data isolation between organizations. Each restaurant operates in its own secure data environment.

### Current Database Schema

```mermaid
erDiagram
    ORGANIZATIONS ||--o{ USERS : contains
    ORGANIZATIONS ||--o{ MERCHANT_CODES : has
    ORGANIZATIONS ||--o{ MODULE_SUBSCRIPTIONS : subscribes
    ORGANIZATIONS ||--o{ PAYMENT_TRANSACTIONS : receives
    ORGANIZATIONS ||--o{ REVENUE_ANALYTICS : generates
    
    USERS {
        uuid id PK
        uuid auth_id UK
        uuid organization_id FK
        string name
        string email UK
        enum role
        boolean is_active
        timestamp last_login
        timestamp created_at
        timestamp updated_at
    }
    
    ORGANIZATIONS {
        uuid id PK
        string name
        string slug UK
        timestamp trial_ends_at
        timestamp created_at
        timestamp updated_at
    }
    
    MERCHANT_CODES {
        uuid id PK
        uuid organization_id FK
        string merchant_code
        string description
        boolean is_active
        timestamp created_at
    }
    
    PAYMENT_TRANSACTIONS {
        uuid id PK
        uuid organization_id FK
        string transaction_id
        decimal amount
        string currency
        date transaction_date
        jsonb raw_data
        timestamp created_at
    }
    
    REVENUE_ANALYTICS {
        uuid id PK
        uuid organization_id FK
        enum period_type
        date period_start
        decimal total_revenue
        integer transaction_count
        timestamp created_at
        timestamp updated_at
    }
```

### Row-Level Security (RLS)

All tables implement Row-Level Security policies to ensure data isolation:

- **Organizations**: Users can only access their own organization
- **Users**: Users can only see users within their organization
- **Payment Transactions**: Isolated by organization_id
- **Revenue Analytics**: Organization-specific data access
- **Merchant Codes**: Organization-specific merchant account management

### Database Functions

**Automated Revenue Analytics:**
```sql
CREATE OR REPLACE FUNCTION update_revenue_analytics()
RETURNS TRIGGER AS $$
-- Automatically updates daily, weekly, and monthly revenue analytics
-- when new payment transactions are inserted
```

**Organization Creation:**
```sql
CREATE OR REPLACE FUNCTION create_organization_with_owner(
    org_name TEXT,
    org_slug TEXT,
    owner_email TEXT,
    owner_name TEXT
) RETURNS uuid
-- Creates organization and initial owner user atomically
```

## API Architecture

### RESTful API Design

The platform exposes a comprehensive REST API with the following endpoints:

**Authentication:**
- `POST /api/auth/signup` - User registration
- `POST /api/auth/logout` - Session termination

**Organizations:**
- `POST /api/organizations` - Create new organization
- `GET /api/organizations/me` - Get current organization

**Users:**
- `GET /api/users` - List organization users
- `POST /api/users` - Create new user
- `DELETE /api/users/[id]` - Delete user
- `POST /api/users/update-login` - Update last login

**Revenue Analytics:**
- `GET /api/revenue?period=daily|weekly|monthly` - Get revenue data

### Authentication Flow

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant S as Supabase
    participant D as Database

    U->>F: Login Request
    F->>S: Authenticate User
    S-->>F: JWT Token
    F->>A: API Request + JWT
    A->>S: Verify Token
    S-->>A: User Data
    A->>D: Query with RLS
    D-->>A: Filtered Results
    A-->>F: Response Data
    F-->>U: UI Update
```

## Module Architecture

### Current Modules

**1. User Management Module**
- Organization registration
- User creation and management
- Role-based access control
- Session management

**2. Revenue Analytics Module**
- Real-time revenue tracking
- Daily/weekly/monthly reports
- Transaction aggregation
- Performance metrics

**3. Shift Planning Module**
- Shift creation and management
- Manager editing capabilities
- Staff schedule viewing
- Role-based permissions

### Planned Modules

**4. Inventory Management** (Phase 3)
- Stock tracking
- Supplier management
- Automated reordering
- Recipe costing

**5. Time Clock Module** (Phase 2)
- Clock in/out functionality
- GPS verification
- Break tracking
- Payroll integration

**6. Menu Management** (Phase 4)
- Digital menu creation
- Dynamic pricing
- Allergen information
- Performance analytics

## Security Architecture

### Multi-Layer Security

1. **Network Security**
   - HTTPS enforcement
   - CORS configuration
   - Rate limiting

2. **Application Security**
   - JWT token validation
   - Input sanitization
   - SQL injection prevention

3. **Database Security**
   - Row-Level Security (RLS)
   - Encrypted connections
   - Audit logging

4. **Access Control**
   - Role-based permissions
   - Organization isolation
   - Session management

### Data Privacy

- **GDPR Compliance**: User data protection and right to deletion
- **Data Isolation**: Complete tenant separation
- **Encryption**: Data encrypted in transit and at rest
- **Audit Trail**: Complete activity logging

## Deployment Architecture

### Development Environment

```mermaid
graph LR
    A[Developer] --> B[Local Development]
    B --> C[Docker Compose]
    C --> D[Supabase Local]
    C --> E[Next.js Dev Server]
    C --> F[n8n Local]
```

### Production Environment

```mermaid
graph TB
    A[Users] --> B[Vercel Edge]
    B --> C[Next.js App]
    C --> D[Supabase Cloud]
    D --> E[PostgreSQL]
    D --> F[Auth Service]
    D --> G[Storage]
    
    H[n8n Cloud] --> I[SumUp API]
    H --> D
    
    J[GitHub] --> K[Vercel Deploy]
    K --> B
```

## Performance & Scalability

### Optimization Strategies

- **Database Indexing**: Optimized queries with proper indexes
- **Caching**: Redis for session and data caching
- **CDN**: Vercel Edge Network for global performance
- **Code Splitting**: Dynamic imports for reduced bundle size
- **Image Optimization**: Next.js automatic image optimization

### Monitoring & Observability

- **Error Tracking**: Sentry for error monitoring
- **Performance**: Web Vitals and Core Web Vitals
- **Analytics**: PostHog for user behavior tracking
- **Uptime**: Health checks and monitoring
- **Logging**: Structured logging with correlation IDs

---

*Last updated: 2025-01-22*